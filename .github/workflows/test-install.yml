name: Test Dotfiles Install

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  test-macos-arm:
    name: macOS (Apple Silicon)
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dry run install
        run: ./install.sh --dry-run --yes

      - name: Check and backup pre-existing dotfiles
        run: |
          echo "Checking for pre-existing dotfiles that might conflict..."
          ls -la ~ | grep -E '^\.[a-z]' || echo "No dotfiles found"
          echo ""
          # Backup and remove files that will conflict with stow
          mkdir -p ~/.dotfiles-ci-backup
          for file in ~/.zshrc ~/.gitconfig ~/.zprofile; do
            if [[ -f "$file" && ! -L "$file" ]]; then
              echo "Backing up existing $file"
              mv "$file" ~/.dotfiles-ci-backup/ || true
            fi
          done

      - name: Run install script
        run: ./install.sh --yes
        env:
          NONINTERACTIVE: 1

      - name: Show install log
        if: always()
        run: |
          echo "=== Install Log ==="
          cat install.log 2>/dev/null || echo "No install.log found"
          echo ""
          echo "=== Install State ==="
          cat .install-state 2>/dev/null || echo "No state file found"

      - name: Verify core tools installed
        run: |
          echo "Checking installed tools..."
          command -v stow && echo "✓ stow"
          command -v zsh && echo "✓ zsh"
          command -v fzf && echo "✓ fzf"
          command -v bat && echo "✓ bat"
          command -v mise && echo "✓ mise"
          command -v node && echo "✓ node"
          command -v python && echo "✓ python"

      - name: Verify stowed configs
        run: |
          echo "Checking symlinked configs..."
          echo ""
          echo "=== Home directory contents ==="
          ls -la ~ | head -30
          echo ""
          echo "=== Dotfiles directory structure ==="
          ls -la "$GITHUB_WORKSPACE"
          echo ""
          echo "=== Zsh stow package ==="
          ls -la "$GITHUB_WORKSPACE/zsh/" || echo "zsh package not found"
          echo ""
          echo "=== Git stow package ==="
          ls -la "$GITHUB_WORKSPACE/git/" || echo "git package not found"
          echo ""
          echo "=== Verifying symlinks ==="
          if [[ -L ~/.zshrc ]]; then
            echo "✓ ~/.zshrc -> $(readlink ~/.zshrc)"
          elif [[ -f ~/.zshrc ]]; then
            echo "✗ ~/.zshrc exists but is a regular file, not a symlink"
            exit 1
          else
            echo "✗ ~/.zshrc does not exist"
            echo "DEBUG: Checking install log for stow info..."
            grep -i stow install.log 2>/dev/null || echo "No stow entries in log"
            exit 1
          fi
          if [[ -L ~/.gitconfig ]]; then
            echo "✓ ~/.gitconfig -> $(readlink ~/.gitconfig)"
          elif [[ -f ~/.gitconfig ]]; then
            echo "✗ ~/.gitconfig exists but is a regular file, not a symlink"
            exit 1
          else
            echo "✗ ~/.gitconfig does not exist"
            exit 1
          fi

      - name: Dry run uninstall
        run: ./uninstall.sh --dry-run --yes

      - name: Run uninstall script
        run: ./uninstall.sh --yes

      - name: Verify configs removed
        run: |
          echo "Checking symlinks are removed..."
          ! test -L ~/.zshrc && echo "✓ ~/.zshrc removed"
          ! test -L ~/.gitconfig && echo "✓ ~/.gitconfig removed"
          echo "Uninstall verified"

  test-ubuntu:
    name: Ubuntu
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check and backup pre-existing dotfiles
        run: |
          echo "Checking for pre-existing dotfiles that might conflict..."
          ls -la ~ | grep -E '^\.[a-z]' || echo "No dotfiles found"
          echo ""
          # Backup and remove files that will conflict with stow
          mkdir -p ~/.dotfiles-ci-backup
          for file in ~/.zshrc ~/.gitconfig ~/.zprofile ~/.bashrc; do
            if [[ -f "$file" && ! -L "$file" ]]; then
              echo "Backing up existing $file"
              mv "$file" ~/.dotfiles-ci-backup/ || true
            fi
          done

      - name: Run install script
        run: ./install.sh --yes
        continue-on-error: true

      - name: Show install log
        if: always()
        run: |
          echo "=== Install Log ==="
          cat install.log 2>/dev/null || echo "No install.log found"
          echo ""
          echo "=== Install State ==="
          cat .install-state 2>/dev/null || echo "No state file found"

      - name: Verify core tools
        run: |
          command -v stow && echo "✓ stow"
          command -v zsh && echo "✓ zsh"
          command -v fzf && echo "✓ fzf"

      - name: Verify stowed configs
        run: |
          echo "Checking symlinked configs..."
          echo ""
          echo "=== Home directory contents ==="
          ls -la ~ | head -30
          echo ""
          echo "=== Dotfiles directory structure ==="
          ls -la "$GITHUB_WORKSPACE"
          echo ""
          echo "=== Zsh stow package ==="
          ls -la "$GITHUB_WORKSPACE/zsh/" || echo "zsh package not found"
          echo ""
          echo "=== Git stow package ==="
          ls -la "$GITHUB_WORKSPACE/git/" || echo "git package not found"
          echo ""
          echo "=== Verifying symlinks ==="
          if [[ -L ~/.zshrc ]]; then
            echo "✓ ~/.zshrc -> $(readlink ~/.zshrc)"
          elif [[ -f ~/.zshrc ]]; then
            echo "✗ ~/.zshrc exists but is a regular file, not a symlink"
            exit 1
          else
            echo "✗ ~/.zshrc does not exist"
            echo "DEBUG: Checking install log for stow info..."
            grep -i stow install.log 2>/dev/null || echo "No stow entries in log"
            exit 1
          fi
          if [[ -L ~/.gitconfig ]]; then
            echo "✓ ~/.gitconfig -> $(readlink ~/.gitconfig)"
          elif [[ -f ~/.gitconfig ]]; then
            echo "✗ ~/.gitconfig exists but is a regular file, not a symlink"
            exit 1
          else
            echo "✗ ~/.gitconfig does not exist"
            exit 1
          fi

      - name: Run uninstall script
        run: ./uninstall.sh --yes

      - name: Verify uninstall
        run: |
          ! test -L ~/.zshrc && echo "✓ ~/.zshrc removed"
          ! test -L ~/.gitconfig && echo "✓ ~/.gitconfig removed"
